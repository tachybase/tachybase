name: Sync Plugins List to docs Repo

on:
  push:
    branches:
      - main
    paths:
      - 'packages/plugin-*/**'
      - 'scripts/generate-plugin-list.mjs'
      - '.github/workflows/sync-plugin-list-to-docs-repo.yml'
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦åŒæ­¥çš„åˆ†æ”¯åç§°'
        required: false
        default: 'main'
        type: string
      reason:
        description: 'åŒæ­¥åŸå› ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-doc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tachybase/tachybase Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Debug - Check current directory after checkout tachybase
        run: |
          echo "ğŸ” å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“ ç›®å½•å†…å®¹:"
          ls -la

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Debug - Check current directory after setup Node
        run: |
          echo "ğŸ” å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“ ç›®å½•å†…å®¹:"
          ls -la

      - name: Generate plugins list
        run: |
          echo "ğŸ” ç”Ÿæˆæ’ä»¶åˆ—è¡¨å‰ - å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          node scripts/generate-plugin-list.mjs
          echo "ğŸ” ç”Ÿæˆæ’ä»¶åˆ—è¡¨å - å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        id: generate-plugins

      - name: Check if plugin-list.md was generated
        run: |
          echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å‰ - å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          if [ ! -f "./docs-dist/plugin-list.md" ]; then
            echo "âŒ plugin-list.md was not generated"
            exit 1
          fi
          echo "âœ… plugin-list.md generated successfully"
          echo "File size: $(wc -l < ./docs-dist/plugin-list.md) lines"
          echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å - å½“å‰å·¥ä½œç›®å½•: $(pwd)"

      - name: Checkout tachybase/docs Repo
        uses: actions/checkout@v4
        with:
          repository: tachybase/docs
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          path: ../docs
          fetch-depth: 0

      - name: Debug - Check current directory after checkout docs
        run: |
          echo "ğŸ” å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“ ä¸»ç›®å½•å†…å®¹:"
          ls -la
          echo "ğŸ“ docs å­ç›®å½•å†…å®¹:"
          ls -la docs/ || echo "docs ç›®å½•ä¸å­˜åœ¨"

      - name: Create backup of current plugin-list.md
        run: |
          echo "ğŸ” åˆ›å»ºå¤‡ä»½å‰ - å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          if [ -f "./docs/zh/plugins/plugin-list.md" ]; then
            cp ./docs/zh/plugins/plugin-list.md ./docs/zh/plugins/plugin-list.md.backup
            echo "âœ… Backup created"
          else
            echo "âš ï¸ No existing plugin-list.md found"
          fi
          echo "ğŸ” åˆ›å»ºå¤‡ä»½å - å½“å‰å·¥ä½œç›®å½•: $(pwd)"

      - name: Copy plugins-list.md
        run: |
          echo "ğŸ” å¤åˆ¶æ–‡ä»¶å‰ - å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p ./docs/zh/plugins/
          cp ../tachybase/docs-dist/plugin-list.md ./docs/zh/plugins/plugin-list.md
          echo "âœ… plugin-list.md copied to docs repo"
          echo "ğŸ” å¤åˆ¶æ–‡ä»¶å - å½“å‰å·¥ä½œç›®å½•: $(pwd)"

      - name: Check for changes
        id: check-changes
        run: |
          echo "ğŸ” æ£€æŸ¥å˜æ›´å‰ - å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          cd docs
          echo "ğŸ” åˆ‡æ¢åˆ° docs ç›®å½•å - å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          if git diff --quiet zh/plugins/plugin-list.md; then
            echo "no-changes=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected in plugin-list.md"
          else
            echo "no-changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in plugin-list.md"
            git diff --stat zh/plugins/plugin-list.md
          fi
          echo "ğŸ” æ£€æŸ¥å˜æ›´å - å½“å‰å·¥ä½œç›®å½•: $(pwd)"

      - name: Debug - Check current directory before PR creation
        run: |
          echo "ğŸ” åˆ›å»º PR å‰ - å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
          ls -la

      - name: Commit and push to docs Repo
        if: steps.check-changes.outputs.no-changes == 'false'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          path: docs
          commit-message: "chore: sync plugins-list.md from tachybase/tachybase repo"
          title: "chore: sync plugins-list.md from tachybase/tachybase repo ${{ github.event.inputs.branch && format('(branch: {0})', github.event.inputs.branch) || '' }}"
          body: |
            ## æ’ä»¶åˆ—è¡¨åŒæ­¥

            æ­¤ PR è‡ªåŠ¨åŒæ­¥äº†æ¥è‡ª tachybase/tachybase ä»“åº“çš„æœ€æ–°æ’ä»¶åˆ—è¡¨ã€‚

            ### å˜æ›´å†…å®¹
            - æ›´æ–°äº† `zh/plugins/plugin-list.md` æ–‡ä»¶
            - åŒæ­¥æ—¶é—´: ${{ github.event.head_commit.timestamp || 'æ‰‹åŠ¨è§¦å‘' }}
            - è§¦å‘æäº¤: ${{ github.sha }}
            ${{ github.event.inputs.branch && format('- æºåˆ†æ”¯: {0}', github.event.inputs.branch) || '' }}
            ${{ github.event.inputs.reason && format('- åŒæ­¥åŸå› : {0}', github.event.inputs.reason) || '' }}

            ### ç›¸å…³é“¾æ¥
            - æºä»“åº“: https://github.com/tachybase/tachybase
            - è§¦å‘æäº¤: https://github.com/tachybase/tachybase/commit/${{ github.sha }}

            ---

            *æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
          branch: sync/plugins-list-${{ github.sha }}
          base: main
          delete-branch: true
          labels: |
            automated
            documentation
            sync

      - name: Debug - Check current directory after PR creation
        run: |
          echo "ğŸ” åˆ›å»º PR å - å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
          ls -la

      - name: Comment on PR if no changes
        if: steps.check-changes.outputs.no-changes == 'true'
        run: |
          echo "ğŸ” æ— å˜æ›´å¤„ç†å‰ - å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "â„¹ï¸ No changes detected in plugin-list.md, skipping PR creation"
          echo "ğŸ” æ— å˜æ›´å¤„ç†å - å½“å‰å·¥ä½œç›®å½•: $(pwd)"
